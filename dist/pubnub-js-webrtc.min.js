!function i(c,a,s){function l(n,e){if(!a[n]){if(!c[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(u)return u(n,!0);var o=new Error("Cannot find module '"+n+"'");throw o.code="MODULE_NOT_FOUND",o}var r=a[n]={exports:{}};c[n][0].call(r.exports,function(e){return l(c[n][1][e]||e)},r,r.exports,i,c,a,s)}return a[n].exports}for(var u="function"==typeof require&&require,e=0;e<s.length;e++)l(s[e]);return l}({1:[function(e,n,t){"use strict";n.exports={newUuid:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,function(e){return(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)})},request:function(i,c,a){return new Promise(function(e,t){var o=new XMLHttpRequest,n=!1;for(var r in a=a||{},o.open(c,i),a.headers)!{}.hasOwnProperty.call(a.headers,r)||(n="content-type"===(r=r.toLowerCase())||n,o.setRequestHeader(r,a.headers[r]));n||o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.onload=function(){if(200<=o.status&&o.status<300){var n;try{n=JSON.parse(o.response)}catch(e){n=o.response}e(n)}else t({status:o.status,statusText:o.statusText})},o.send(JSON.stringify(a.body))})},isValidConstructorConfig:function(e){var n="isValidConstructorConfig",t=!0;if(!e.pubnub){var o="WebRTC [".concat(n,"] error. ")+"Cannot initialize [WebRtcPhone] without passing an instance of the PubNub JS SDK.";console.error(o),t=!1}if(!e.onIncomingCall){var r="WebRTC [".concat(n,"] error. ")+"Cannot initialize [WebRtcPhone] without passing a handler for the [onIncomingCall] event.";console.error(r),t=!1}if(!e.onCallResponse){var i="WebRTC [".concat(n,"] error. ")+"Cannot initialize [WebRtcPhone] without passing a handler for the [onCallResponse] event.";console.error(i),t=!1}if(!e.onPeerStream){var c="WebRTC [".concat(n,"] error. ")+"Cannot initialize [WebRtcPhone] without passing a handler for the [onPeerStream] event.";console.error(c),t=!1}if(!e.onDisconnect){var a="WebRTC [".concat(n,"] error. ")+"Cannot initialize [WebRtcPhone] without passing a handler for the [onDisconnect] event.";console.error(a),t=!1}return t}}},{}],2:[function(e,n,t){"use strict";function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var f=e("./helpers/util.js");function d(e){return(d="function"==typeof Symbol&&"symbol"===o(Symbol.iterator)?function(e){return o(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":o(e)})(e)}function r(e,n){for(var t=0;t<n.length;t++){var o=n[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var i,c,a,s=["$webRTC","peerIceCandidate"].join("."),h=["$webRTC","incomingCall"].join("."),p=["$webRTC","callResponse"].join("."),l=(i=u,(c=[{key:"callUser",value:function(n,e){var t=this,o=e.onPeerStream,r=e.myStream,i=e.offerOptions,c=e.rtcConfig,a=this.pubnub.getUUID();c=this.rtcConfig=c||this.rtcConfig,r=this.myStream=r||this.myStream,o=this.onPeerStream=o||this.onPeerStream,i=i||{offerToReceiveAudio:1,offerToReceiveVideo:1};var s,l=this.peerConnection=new RTCPeerConnection(c),u=this.callId=(0,f.newUuid)();l.ontrack=o,r.getTracks().forEach(function(e){l.addTrack(e,r)}),l.iceCache=[],l.oniceconnectionstatechange=function(){"disconnected"===l.iceConnectionState&&t.disconnect()},l.onicecandidate=function(e){e.candidate&&b(e,n,l,u,t.pubnub)},l.onnegotiationneeded=function(){l.createOffer(i).then(function(e){return s=e,l.setLocalDescription(s)}).then(function(){var e=[h,n].join(".");t.pubnub.publish({channel:e,message:{callId:u,sender:a,rtcConfig:c,remoteDescription:s}})}).catch(function(e){var n="WebRTC [".concat("callUser","] error.");console.error(n,e)})}}},{key:"disconnect",value:function(){this.peerConnection&&(this.peerConnection.close(),delete this.peerConnection),this.callInSession=!1,this.onDisconnect()}}])&&r(i.prototype,c),void(a&&r(i,a)),u);function u(e){var c=this;if(function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}(this,u),(0,f.isValidConstructorConfig)(e)){this.pubnub=e.pubnub,this.onIncomingCall=e.onIncomingCall,this.onCallResponse=e.onCallResponse,this.onPeerStream=e.onPeerStream,this.onDisconnect=e.onDisconnect,this.myStream=e.myStream,this.rtcConfig=e.rtcConfig,this.ignoreNonTurn=e.ignoreNonTurn;var a=this.pubnub.getUUID();this.pubnub.addListener({message:function(e){var n=e.channel,t=n.includes(h),o=n.includes(p),r=n.includes(s),i=n.includes(a);t&&i?function(e){var s=this,l=e.sender,u=e.callId,f=e.rtcConfig,h=e.remoteDescription;this.onIncomingCall(l,function(e){var n=e.acceptedCall,t=e.onPeerStream,o=e.myStream;if(o=s.myStream=o||s.myStream,t=t||s.onPeerStream,n){if("object"!==d(o)){var r="WebRTC [".concat("incomingCall","]:")+"No local video stream defined.";console.error(r)}var i,c=s.peerConnection=new RTCPeerConnection(f);c.ontrack=t,c.iceCache=[],o.getTracks().forEach(function(e){c.addTrack(e,o)}),c.oniceconnectionstatechange=function(){"disconnected"===c.iceConnectionState&&s.disconnect()},c.onicecandidate=function(e){e.candidate&&b(e,l,c,u,s.pubnub)},c.setRemoteDescription(h).then(function(){return c.createAnswer()}).then(function(e){return i=e,c.setLocalDescription(i)}).then(function(){c.acceptedCall=!0,s.callInSession=!0,C(l,c,u,s.pubnub);var e=[p,l].join(".");s.pubnub.publish({channel:e,message:{sender:s.pubnub.getUUID(),callId:u,acceptedCall:n,remoteDescription:i}})}).catch(function(e){var n="WebRTC [".concat("incomingCall","] error.");console.error(n,e)})}else{var a=[p,l].join(".");s.pubnub.publish({channel:a,message:{callId:u,acceptedCall:n}})}})}.call(c,e.message):o&&i?function(e){var n=this,t=e.sender,o=e.callId,r=e.acceptedCall,i=e.remoteDescription;r&&(this.peerConnection.acceptedCall=!0,this.callInSession=!0,this.peerConnection.setRemoteDescription(i).then(function(){C(t,n.peerConnection,o,n.pubnub)}).catch(function(e){var n="WebRTC [".concat("callResponse","] error.");console.error(n,e)}));this.onCallResponse(r)}.call(c,e.message):r&&i&&function(e){var n=this.peerConnection,t=this.ignoreNonTurn,o=(e.callId,e.candidates);if("object"!==d(o)||!n)return;o.forEach(function(e){t&&-1===e.candidate.indexOf("typ relay")||n.addIceCandidate(e).catch(function(e){if("Error processing ICE candidate"!==e.message){var n="WebRTC [".concat("peerIceCandidate","] error.");console.error(n,e)}})})}.call(c,e.message)}});var n=[h,a].join("."),t=[p,a].join("."),o=[s,a].join(".");this.pubnub.subscribe({channels:[n,t,o]})}}function b(e,n,t,o,r){t.iceCache.push(e.candidate),t.acceptedCall&&C(n,t,o,r)}function C(e,n,t,o){var r=[s,e].join(".");o.publish({channel:r,message:{callId:t,candidates:n.iceCache}}),n.iceCache=[]}window.WebRtcPhone=l},{"./helpers/util.js":1}]},{},[2]);